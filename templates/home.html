{% extends "base.html" %}

{% block title %}Home - ReutilizaIF{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css" />
<style>
    .page-header {
        margin-bottom: 40px;
    }
    .page-header h1 {
        font-size: 2.5em;
        font-weight: 700;
        color: #000;
        margin-bottom: 10px;
        font-family: 'Poppins', sans-serif;
    }
    .page-header p {
        color: #666;
        font-size: 1.1em;
    }
    .quick-actions {
        display: flex;
        gap: 20px;
        margin-bottom: 40px;
        flex-wrap: wrap;
    }
    .quick-action-card {
        flex: 1;
        min-width: 200px;
        background: #fff;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 30px;
        text-align: center;
        transition: all 0.3s ease;
        text-decoration: none;
        color: inherit;
    }
    .quick-action-card:hover {
        border-color: #00FF88;
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0,255,136,0.15);
    }
    .quick-action-card h3 {
        font-size: 1.3em;
        font-weight: 600;
        margin-bottom: 10px;
        color: #000;
    }
    .quick-action-card p {
        color: #666;
        font-size: 0.95em;
    }
    .produtos-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 30px;
        margin-top: 20px;
    }
    .produto-card {
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        padding: 30px;
        transition: all 0.3s ease;
    }
    .produto-card:hover {
        border-color: #00FF88;
        box-shadow: 0 4px 12px rgba(0,255,136,0.1);
        transform: translateY(-2px);
    }
    .produto-card .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: 600;
        margin-bottom: 15px;
    }
    .badge-venda {
        background: #00FF88;
        color: #000;
    }
    .badge-troca {
        background: #e0e0e0;
        color: #333;
    }
    .produto-card strong {
        color: #000;
        font-size: 1.3em;
        font-weight: 600;
        display: block;
        margin-bottom: 15px;
    }
    .produto-card .preco {
        color: #00FF88;
        font-size: 1.8em;
        font-weight: 700;
        margin: 15px 0;
    }
    .produto-card .preco-troca {
        color: #666;
        font-size: 1em;
        font-style: italic;
    }
    .produto-card .descricao {
        color: #666;
        line-height: 1.7;
        font-size: 0.95em;
        margin-bottom: 15px;
    }
    .produto-meta {
        margin-top: 15px;
        font-size: 0.9em;
        color: #666;
        padding-top: 15px;
        border-top: 1px solid #e0e0e0;
    }
    .produto-meta a {
        color: #000;
        font-weight: 600;
        text-decoration: none;
    }
    .produto-meta a:hover {
        color: #00FF88;
        text-decoration: underline;
    }
    .produto-actions {
        margin-top: 20px;
        display: flex;
        gap: 12px;
    }
    .produto-actions form {
        margin: 0;
    }
    .btn-small {
        padding: 8px 16px;
        font-size: 0.85em;
    }
    .empty-state {
        text-align: center;
        padding: 80px 20px;
        color: #999;
    }
    .empty-state p {
        font-size: 1.2em;
        margin-bottom: 20px;
    }
    #map-home {
        position: relative;
        overflow: hidden;
        z-index: 0;
    }
    .quick-actions {
        position: relative;
        z-index: 1;
    }
    .ol-popup {
        position: absolute;
        background-color: white;
        padding: 10px 14px;
        border-radius: 8px;
        border: 1px solid #ccc;
        bottom: 12px;
        left: -50px;
        min-width: 200px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    .ol-popup-closer {
        position: absolute;
        top: 4px;
        right: 8px;
        text-decoration: none;
        color: #999;
        font-size: 18px;
    }
    .ol-popup-closer:hover {
        color: #000;
    }
    .ol-control {
        font-family: 'Poppins', sans-serif;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>Bem-vindo ao ReutilizaIF</h1>
        <p>Plataforma de reutilização e compartilhamento de recursos</p>
    </div>

    <div style="margin-bottom: 40px; position: relative;">
        <h2 style="font-size: 1.8em; font-weight: 600; margin-bottom: 20px; color: #000;">
            <i class="fas fa-map"></i> Mapa de Produtos
        </h2>
        <div id="map-home" style="height: 500px; width: 100%; border-radius: 12px; border: 2px solid #e0e0e0; position: relative; overflow: hidden;"></div>
    </div>

    <div class="quick-actions" style="position: relative; z-index: 10;">
        <a href="{{ url_for('produtos.venda') }}" class="quick-action-card">
            <i class="fas fa-shopping-cart" style="font-size: 2em; color: #00FF88; margin-bottom: 10px;"></i>
            <h3>Venda</h3>
            <p>Produtos à venda</p>
        </a>
        <a href="{{ url_for('produtos.troca') }}" class="quick-action-card">
            <i class="fas fa-exchange-alt" style="font-size: 2em; color: #00FF88; margin-bottom: 10px;"></i>
            <h3>Troca</h3>
            <p>Produtos para troca</p>
        </a>
        <a href="{{ url_for('produtos.novo_produto') }}" class="quick-action-card">
            <i class="fas fa-plus-circle" style="font-size: 2em; color: #00FF88; margin-bottom: 10px;"></i>
            <h3>Adicionar</h3>
            <p>Cadastrar novo produto</p>
        </a>
    </div>

    <h2 style="font-size: 1.8em; font-weight: 600; margin-bottom: 20px; color: #000;">
        <i class="fas fa-box"></i> Produtos Disponíveis
    </h2>
    
    {% if produtos_com_avaliacoes %}
        <div class="produtos-grid">
            {% for item in produtos_com_avaliacoes %}
                {% set produto = item.produto %}
                {% set media_avaliacao = item.media_avaliacao %}
                {% set total_avaliacoes = item.total_avaliacoes %}
                <div class="produto-card">
                    <span class="badge {% if produto.tipo == 'venda' %}badge-venda{% else %}badge-troca{% endif %}">
                        {{ produto.tipo|title }}
                    </span>
                    <strong>{{ produto.nome }}</strong>
                    {% if produto.tipo == 'venda' %}
                    <div class="preco">R$ {{ "%.2f"|format(produto.preco) }}</div>
                    {% else %}
                    <div class="preco-troca">Disponível para troca</div>
                    {% endif %}
                    {% if produto.descricao %}
                    <div class="descricao">{{ produto.descricao }}</div>
                    {% endif %}
                    
                    {% if total_avaliacoes > 0 %}
                    <div style="margin: 15px 0; display: flex; align-items: center; gap: 8px;">
                        <div style="color: #FFD700;">
                            {% for i in range(5) %}
                                {% if i < media_avaliacao|int %}
                                    <i class="fas fa-star"></i>
                                {% elif i < media_avaliacao %}
                                    <i class="fas fa-star-half-alt"></i>
                                {% else %}
                                    <i class="far fa-star"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <span style="color: #666; font-size: 0.9em;">({{ total_avaliacoes }} avaliações)</span>
                    </div>
                    {% endif %}
                    
                    {% if produto.usuario_matricula %}
                    <div class="produto-meta">
                        Publicado por
                        <a href="{{ url_for('perfil.usuario_publico', matricula=produto.usuario_matricula) }}">
                            {{ produto.usuario_nome or produto.usuario_matricula }}
                        </a>
                    </div>
                    {% endif %}
                    
                    <div class="produto-actions" style="margin-top: 15px;">
                        <button onclick="abrirAvaliacao({{ produto.id }})" class="btn btn-secondary btn-small" style="display: inline-flex; align-items: center; gap: 5px;">
                            <i class="fas fa-star"></i>
                            <span>Avaliar</span>
                        </button>
                        {% if is_admin %}
                        <a href="{{ url_for('produtos.editar_produto', produto_id=produto.id) }}" class="btn btn-secondary btn-small">Editar</a>
                        <form action="{{ url_for('produtos.excluir_produto', produto_id=produto.id) }}" method="post" onsubmit="return confirm('Tem certeza que deseja remover este produto?');" style="display: inline;">
                            <button type="submit" class="btn btn-danger btn-small">Remover</button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <p>Nenhum produto cadastrado ainda.</p>
            <a href="{{ url_for('produtos.novo_produto') }}" class="btn btn-primary">Adicionar Primeiro Produto</a>
        </div>
    {% endif %}
</div>

<!-- Modal de Avaliação -->
<div id="modalAvaliacao" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
        <h3 style="margin-bottom: 20px;">Avaliar Produto</h3>
        <form id="formAvaliacao" onsubmit="enviarAvaliacao(event)">
            <input type="hidden" id="produto_id_avaliacao" name="produto_id">
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px;">Nota (1-5 estrelas)</label>
                <div id="estrelas" style="font-size: 2em; color: #FFD700; cursor: pointer;">
                    <i class="far fa-star" data-nota="1"></i>
                    <i class="far fa-star" data-nota="2"></i>
                    <i class="far fa-star" data-nota="3"></i>
                    <i class="far fa-star" data-nota="4"></i>
                    <i class="far fa-star" data-nota="5"></i>
                </div>
                <input type="hidden" id="nota_avaliacao" name="nota" required>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px;">Comentário (opcional)</label>
                <textarea name="comentario" class="ui-textarea" style="width: 100%;"></textarea>
            </div>
            <div style="display: flex; gap: 10px;">
                <button type="submit" class="ui-btn ui-btn-primary">Enviar Avaliação</button>
                <button type="button" onclick="fecharAvaliacao()" class="ui-btn ui-btn-secondary">Cancelar</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}


{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>
<script>
    // Mapa na home com OpenLayers (apenas produtos)
    const mapHomeElement = document.getElementById('map-home');
    if (mapHomeElement) {
        const produtos = [
            {% if produtos_mapa %}
            {% for produto in produtos_mapa %}
            {
                nome: '{{ produto.nome|replace("\'","\\'") }}',
                tipo: '{{ produto.tipo }}',
                latitude: {{ produto.latitude }},
                longitude: {{ produto.longitude }},
                preco: {% if produto.tipo == 'venda' %}'R$ {{ "%.2f"|format(produto.preco) }}'{% else %}'Disponível para troca'{% endif %}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
            {% endif %}
        ];

        const view = new ol.View({
            center: ol.proj.fromLonLat([-35.2110, -5.7945]),
            zoom: 13
        });

        const features = produtos.map((p) => {
            const feature = new ol.Feature({
                geometry: new ol.geom.Point(ol.proj.fromLonLat([p.longitude, p.latitude])),
                nome: p.nome,
                tipo: p.tipo,
                preco: p.preco
            });
            return feature;
        });

        const styleFunction = (feature) => {
            const tipo = feature.get('tipo');
            const isVenda = tipo === 'venda';
            return new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 11,
                    fill: new ol.style.Fill({ color: isVenda ? '#00FF88' : '#e0e0e0' }),
                    stroke: new ol.style.Stroke({ color: '#000', width: 2 })
                }),
                text: new ol.style.Text({
                    text: isVenda ? 'V' : 'T',
                    fill: new ol.style.Fill({ color: '#000' }),
                    font: 'bold 12px Poppins, sans-serif'
                })
            });
        };

        const vectorLayer = new ol.layer.Vector({
            source: new ol.source.Vector({ features }),
            style: styleFunction
        });

        // Mapa minimalista em cinza (apenas ruas)
        const tileLayer = new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://{a-c}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
                attributions: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/attributions">CARTO</a>'
            })
        });

        const mapHome = new ol.Map({
            target: 'map-home',
            layers: [tileLayer, vectorLayer],
            view
        });

        // Ajusta o mapa para caber os produtos, se existirem
        if (features.length > 0) {
            const extent = vectorLayer.getSource().getExtent();
            mapHome.getView().fit(extent, { padding: [40, 40, 40, 40], maxZoom: 16 });
        }

        // Popup simples
        const popupContainer = document.createElement('div');
        popupContainer.className = 'ol-popup';
        popupContainer.style.position = 'absolute';
        popupContainer.style.zIndex = '1000';
        const popupCloser = document.createElement('a');
        popupCloser.className = 'ol-popup-closer';
        popupCloser.href = '#';
        popupCloser.innerHTML = '&times;';
        popupContainer.appendChild(popupCloser);
        const popupContent = document.createElement('div');
        popupContainer.appendChild(popupContent);
        document.body.appendChild(popupContainer);

        const overlay = new ol.Overlay({
            element: popupContainer,
            autoPan: { animation: { duration: 250 } }
        });
        mapHome.addOverlay(overlay);

        popupCloser.onclick = function () {
            overlay.setPosition(undefined);
            popupCloser.blur();
            return false;
        };

        mapHome.on('singleclick', function (evt) {
            const feature = mapHome.forEachFeatureAtPixel(evt.pixel, (ft) => ft);
            if (feature) {
                const coord = feature.getGeometry().getCoordinates();
                const nome = feature.get('nome');
                const tipo = feature.get('tipo');
                const preco = feature.get('preco');
                popupContent.innerHTML = `<strong>${nome}</strong><br>${tipo.charAt(0).toUpperCase() + tipo.slice(1)}<br>${preco}`;
                overlay.setPosition(coord);
            } else {
                overlay.setPosition(undefined);
            }
        });
    }

    // Sistema de avaliação
    let notaSelecionada = 0;
    
    function abrirAvaliacao(produtoId) {
        document.getElementById('produto_id_avaliacao').value = produtoId;
        document.getElementById('modalAvaliacao').style.display = 'flex';
        notaSelecionada = 0;
        atualizarEstrelas();
    }
    
    function fecharAvaliacao() {
        document.getElementById('modalAvaliacao').style.display = 'none';
        document.getElementById('formAvaliacao').reset();
        notaSelecionada = 0;
        atualizarEstrelas();
    }
    
    function atualizarEstrelas() {
        const estrelas = document.querySelectorAll('#estrelas i');
        estrelas.forEach((estrela, index) => {
            if (index < notaSelecionada) {
                estrela.className = 'fas fa-star';
            } else {
                estrela.className = 'far fa-star';
            }
        });
        document.getElementById('nota_avaliacao').value = notaSelecionada;
    }
    
    document.querySelectorAll('#estrelas i').forEach(estrela => {
        estrela.addEventListener('click', function() {
            notaSelecionada = parseInt(this.getAttribute('data-nota'));
            atualizarEstrelas();
        });
        estrela.addEventListener('mouseenter', function() {
            const nota = parseInt(this.getAttribute('data-nota'));
            const estrelas = document.querySelectorAll('#estrelas i');
            estrelas.forEach((e, index) => {
                if (index < nota) {
                    e.className = 'fas fa-star';
                } else {
                    e.className = 'far fa-star';
                }
            });
        });
    });
    
    document.getElementById('estrelas').addEventListener('mouseleave', atualizarEstrelas);
    
    function enviarAvaliacao(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const produtoId = document.getElementById('produto_id_avaliacao').value;
        
        fetch(`/produtos/${produtoId}/avaliar`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.sucesso) {
                alert('Avaliação enviada com sucesso!');
                fecharAvaliacao();
                location.reload();
            } else {
                alert(data.erro || 'Erro ao enviar avaliação');
            }
        })
        .catch(error => {
            alert('Erro ao enviar avaliação');
            console.error(error);
        });
    }
</script>
{% endblock %}
